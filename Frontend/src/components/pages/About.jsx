import React, { useState, useEffect } from "react";
import './About.css';

export const About = () => {
  const [rooms, setRooms] = useState([]);
  const [newRoom, setNewRoom] = useState({
    room_name: "",
    description: "",
    image: "",
    capacity: "", // Added capacity field
    location: ""  // Added location field
  });
  const [showForm, setShowForm] = useState(false);
  const [editingRoomId, setEditingRoomId] = useState(null);
  const [showBookingModal, setShowBookingModal] = useState(false);
  const [selectedRoom, setSelectedRoom] = useState(null);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [detailRoom, setDetailRoom] = useState(null);

  useEffect(() => {
    fetchRooms();
  }, []);

  const fetchRooms = async () => {
    try {
      const response = await fetch("http://localhost:3000/api/rooms");
      const data = await response.json();
      setRooms(data);
    } catch (error) {
      console.error("Error fetching rooms:", error);
    }
  };

  const handleChange = (e) => {
    setNewRoom({
      ...newRoom,
      [e.target.name]: e.target.value
    });
  };

  const handleImageChange = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setNewRoom((prev) => ({ ...prev, image: reader.result }));
      };
      reader.readAsDataURL(file);
    }
  };

  const publicHolidays = ["01-01", "04-13", "04-14", "04-15", "12-05", "12-10"];
  const getMinutes = (time) => time.split(":")[1];
  const isHoliday = (dateString) => {
    const date = new Date(dateString);
    const day = date.getDay();
    const formatted = date.toISOString().slice(5, 10);
    return day === 0 || day === 6 || publicHolidays.includes(formatted);
  };

  const handleAddOrUpdateRoom = async () => {
    if (!newRoom.room_name || !newRoom.description || !newRoom.image || !newRoom.capacity || !newRoom.location) {
      return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    }

    try {
      const response = await fetch(`http://localhost:3000/api/rooms${editingRoomId ? `/${editingRoomId}` : ''}`, {
        method: editingRoomId ? 'PUT' : 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(newRoom)
      });

      if (!response.ok) {
        throw new Error('Network response was not ok');
      }

      const updatedRoom = await response.json();
      const updatedRooms = editingRoomId
        ? rooms.map(room => room._id === editingRoomId ? updatedRoom : room)
        : [...rooms, updatedRoom];

      setRooms(updatedRooms);
      setNewRoom({ room_name: "", description: "", image: "", capacity: "", location: "" });
      setShowForm(false);
      setEditingRoomId(null);
    } catch (error) {
      console.error("Error adding/updating room:", error);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á");
    }
  };

  const handleEdit = (room) => {
    setNewRoom({
      room_name: room.room_name,
      description: room.description,
      image: room.image,
      capacity: room.capacity, // Added capacity field
      location: room.location  // Added location field
    });
    setEditingRoomId(room._id);
    setShowForm(true);
  };

  const handleDelete = (id) => {
    if (window.confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?")) {
      const updatedRooms = rooms.filter(room => room._id !== id);
      setRooms(updatedRooms);
      localStorage.setItem("rooms", JSON.stringify(updatedRooms));
    }
  };

  const handleViewDetails = (room) => {
    setDetailRoom(room);
    setShowDetailModal(true);
  };

  const closeDetailModal = () => {
    setShowDetailModal(false);
    setDetailRoom(null);
  };

  const handleBookRoom = (room) => {
    setSelectedRoom(room);
    setShowBookingModal(true);
  };

  const closeBookingModal = () => {
    setShowBookingModal(false);
    setSelectedRoom(null);
  };

  return (
    <div className="about-container centered-content">
      <div className="title-container">
        <h2>&nbsp;‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</h2>
      </div>

      <ul className="about-list">
        {rooms.map((room) => (
          <li key={room._id}>
            <img
              src={room.image}
              alt={room.room_name}
              className="room-image"
              width="220"
              height="170"
            />
            <div className="room-details">
              <h2 className="room-title">{room.room_name}</h2>
              <p>{room.description}</p>
              <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> {room.capacity}</p> {/* Display capacity */}
              <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> {room.location}</p> {/* Display location */}

              <div className="room-buttons">
                <div className="left-buttons">
                  <button className="btn blue" onClick={() => handleBookRoom(room)}>‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</button>
                  <button className="btn yellow" onClick={() => handleViewDetails(room)}>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                </div>
                <div className="right-buttons">
                  <button className="btn orange" onClick={() => handleEdit(room)}>üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                  <button className="btn red" onClick={() => handleDelete(room._id)}>üóëÔ∏è ‡∏•‡∏ö</button>
                </div>
              </div>
            </div>
          </li>
        ))}
      </ul>

      {!showForm && (
        <div className="text-center my-4">
          <button className="btn green" onClick={() => setShowForm(true)}>
            ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
      )}

      {showForm && (
        <div className="modal-overlay">
          <div className="modal-content">
            <div className="form-header">
              <h4>{editingRoomId ? "üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡πâ‡∏≠‡∏á" : "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"}</h4>
              <button className="btn red" onClick={() => { setShowForm(false); setEditingRoomId(null); }}>‚ùå</button>
            </div>
            <input
              type="text"
              name="room_name"
              placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á"
              value={newRoom.room_name}
              onChange={handleChange}
            />
            <input
              type="text"
              name="description"
              placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á"
              value={newRoom.description}
              onChange={handleChange}
            />
            <input
              type="text"
              name="capacity"
              placeholder="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏"
              value={newRoom.capacity}
              onChange={handleChange}
            />
            <input
              type="text"
              name="location"
              placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà"
              value={newRoom.location}
              onChange={handleChange}
            />
            <input
              type="file"
              accept="image/*"
              onChange={handleImageChange}
            />
            {newRoom.image && (
              <div className="image-preview">
                <img
                  src={newRoom.image}
                  alt="Preview"
                  width="100%"
                  style={{ marginTop: '1rem', borderRadius: '8px' }}
                />
              </div>
            )}
            <button className="btn green" onClick={handleAddOrUpdateRoom}>
              {editingRoomId ? "‚úî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç" : "‚úî ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á"}
            </button>
          </div>
        </div>
      )}

      {/* ‚úÖ Booking Modal */}
      {showBookingModal && selectedRoom && (
        <div className="modal-overlay">
          <div className="modal-content">
            <div className="form-header">
              <h4>üìÖ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á: {selectedRoom.room_name}</h4>
              <button className="btn red" onClick={closeBookingModal}>‚ùå</button>
            </div>

            <p><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á:</strong> {selectedRoom.description}</p>
            <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> {selectedRoom.capacity}</p> {/* Display capacity */}
            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> {selectedRoom.location}</p> {/* Display location */}
            <img
              src={selectedRoom.image}
              alt={selectedRoom.room_name}
              width="100%"
              style={{ marginTop: '1rem', borderRadius: '8px' }}
            />

            <div style={{ marginTop: '1rem' }}>
              <label>üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</label>
              <input
                type="text"
                value={selectedRoom.bookedBy || ""}
                onChange={(e) => setSelectedRoom({ ...selectedRoom, bookedBy: e.target.value })}
                placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á"
              />
            </div>

            <div style={{ marginTop: '0.5rem' }}>
              <label>üìå ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡∏á:</label>
              <input
                type="date"
                value={selectedRoom.bookingDate || ""}
                onChange={(e) => setSelectedRoom({ ...selectedRoom, bookingDate: e.target.value })}
              />
              {selectedRoom.bookingDate && isHoliday(selectedRoom.bookingDate) && (
                <p style={{ color: 'red', fontWeight: 'bold', marginTop: '0.3rem' }}>
                  üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå‡πÑ‡∏î‡πâ
                </p>
              )}
            </div>

            <div style={{ marginTop: '0.5rem' }}>
              <label>üïê ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á:</label>
              <div style={{ display: 'flex', gap: '0.5rem' }}>
                <input
                  type="time"
                  step="3600"
                  value={selectedRoom.startTime || ""}
                  onChange={(e) => setSelectedRoom({ ...selectedRoom, startTime: e.target.value })}
                />
                <span style={{ alignSelf: 'center' }}>‡∏ñ‡∏∂‡∏á</span>
                <input
                  type="time"
                  step="3600"
                  value={selectedRoom.endTime || ""}
                  onChange={(e) => setSelectedRoom({ ...selectedRoom, endTime: e.target.value })}
                />
              </div>
            </div>

            <div style={{ marginTop: '0.5rem' }}>
              <label>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:</label>
              <textarea
                rows="3"
                placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                value={selectedRoom.bookingNote || ""}
                onChange={(e) => setSelectedRoom({ ...selectedRoom, bookingNote: e.target.value })}
              />
            </div>

            <button
              className="btn green"
              style={{ marginTop: '1rem' }}
              onClick={() => {
                const { bookedBy, bookingDate, startTime, endTime } = selectedRoom;

                if (!bookedBy || !bookingDate || !startTime || !endTime) {
                  return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô");
                }

                if (isHoliday(bookingDate)) {
                  return alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö");
                }

                if (getMinutes(startTime) !== "00" || getMinutes(endTime) !== "00") {
                  return alert("‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡πÄ‡∏ä‡πà‡∏ô 08:00 - 09:00 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
                }

                if (startTime >= endTime) {
                  return alert("‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î");
                }

                if (startTime < "08:00" || endTime > "19:00") {
                  return alert("‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 08:00 ‡∏ñ‡∏∂‡∏á 19:00 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
                }

                alert(
                  `‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${bookedBy}\n‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${bookingDate}\n‡πÄ‡∏ß‡∏•‡∏≤: ${startTime} ‡∏ñ‡∏∂‡∏á ${endTime}\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${selectedRoom.bookingNote || "-"}`
                );

                closeBookingModal();
              }}
            >
              ‚úî ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
            </button>

          </div>
        </div>
      )}
      {/* ‚úÖ Detail Modal */}
      {showDetailModal && detailRoom && (
        <div className="modal-overlay">
          <div className="modal-content" >
            <div className="form-header">
              <h4>üìñ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>
              <button className="btn red" onClick={closeDetailModal}>‚ùå</button>
            </div>
            <img width="100%"
              src={detailRoom.image}
              alt={detailRoom.room_name}
            />
            <h3 >{detailRoom.room_name}</h3>
            <p>{detailRoom.description}</p>
            <p><strong>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏:</strong> {detailRoom.capacity}</p> {/* Display capacity */}
            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> {detailRoom.location}</p> {/* Display location */}
          </div>
        </div>
      )}
    </div>
  );
};